# HTTP 캐시 사용하기

### 웹 캐시란

- 클라이언트가 요청하는 자원을 첫 요청 시에 파일을 내려 받아, 특정 위치에 복사본을 저장하고, 이후 동일한 url 의 리소스를 요청한다면 내부에 저장한 파일을 사용하여 더 빠르게 서비스하기 위한 것
- 서버를 통해 내려 받는 양이 적어지니 응답 시간이 감소하고, 네트워크 트래픽도 감소하게 된다.

## Cache-Control - max age

### 캐시 유효기간 : max-age

- max-age 지정을 통해 리소스의 캐시가 유효한 시간을 정할 수 있다.
- 캐시의 유효기간이 지나기 전에는 브라우저는 서버에 요청을 보내지 않고 디스크 또는 메모리에서만 캐시를 읽어와 계속 사용한다.
- 한번 브라우저에 캐시가 저장되면 만료될 때 까지는 계속 브라우저에 남아 있게 된다.

### 캐시 유효기간이 지난 이후

- 브라우저는 서버에 조건부 요청을 통해 캐시가 유효한지 재검증을한다.
- 재검증 결과, 브라우저가 가지고 있는 캐시가 유효하다면 서버는 304 Not Modified 요청을 내려준다.
- 재검증 요청 헤더들은 아래와 같다.
  - if-None-match : 캐시된 리소스의 `ETag` 값과 현재 서버 리소스의 `ETag`값이 같은지 확인
  - if-Modifed-Since: 캐시된 리소스의 `Last-Modifed`값이 이후에 서버 리소스가 수정되었는지 확인
- 재검증 결과 캐시가 유효하지 않으면 서버는 200OK 또는 적합상 상태코드를 본문과 함께 내려준다.

## Cache-Control - NoCache, NoStore

### No-Cache 와 No-Store

- No-Cache : max-age=0 과 동일한 뜻. 즉, 캐시는 저장하지만 사용하려고 할 때 마다 서버에 재검증 요청을 보내야한다.
- No-Store: 캐시를 절대로 해서 안되는 리소스에 사용. 브라우저는 어떤 경우에도 캐시 저장소에 해당 리소스를 저장하지 않는다.

## Cache-Control - s-maxage

- 중간 서버에서만 적용되는 max-age 값
- 예를 들어, Cache-Control 값을 s-maxage=1년, max-age=0과 같이 설정하면 CDN에서는 1년동안 캐시되지만, 브라우저에서는 매번 재검증 요청을 보내도록 설정 가능

## Cache-Control - must-revalidate

- 만료된 캐시만 서버에 확인 받도록 한다.

## Cache-Control - public , private

- public: 공유 캐시(중개서버)에 저장해도 된다는 뜻
- private : 브라우저 같은 특정 사용자 환경에서만 저장하라는 뜻

## `Etag`헤더

- 이미지,CSS,JS 와 같은 정적 파일은 자동으로 Etag 헤더를 붙여준다.
- 파일 수정 여부를 판별한다.
- HTTP 컨텐츠가 바뀌었는지 검사 할 수 있는 태그이다.
- 같은 주소의 자원이라도 컨텐츠가 달라졌다면 Etag 가 달라진다.

## If-Nont-Match

- 서버보고 Etag 가 달라졌는지 검사해서 Etag 가 달라진 경우에만 컨텐츠를 새로 내려주라는 뜻

## Last-Modified 헤더

- 브라우저가 서버로 요청한 파일의 최종 수정 시간을 알려준다.

## 캐시 적용하기 - HTML 파일

- HTML 리소스는. 새로 배포가 이루어질때마다 값이 바뀔 수 있다. 때문에 브라우저는 항상 HTML 파일을 불러올 때 새로운 배포가 있는지 확인해야했다.
- 이를 위해 max-age=0 , s-maxage=31536000 으로 했다. 이로써 브라우저는 HTML 파일을 가져올 때 마다 서버에 재검증 요청을 보내고, 그 사이에 배포가 있었다면 새로운 HTML 파일을 받아오도록 했다.
- CDN 처럼 사용한 nginx 서버에서는 html cache 를 계속 가지고 있도록 했다. (s-maxage가 중간서버.)
  - 왜냐하면, 새로 배포할 때마다 invalidation 을 해줬기 때문이다.

## 캐시 적용하기- JS,CSS 파일

- JS 나 CSS는 프론트엔드 웹 서비스를 빌드할때마다 새로 생긴다.
- 임의의 버전 번호를 url 앞부분에 붙여서 빌드 결과물마다 (chunk) 고유한 url 을 가지도록 설정했다!
  - 따라서, 같은 url에 대해 내용이 바뀔 수 있는 경우는 없다. 내용이 바뀔 여지가 없으므로 리소스의 캐시가 만료될 일도 없당.
- _max-age=31536000_
- 새로 배포가 일어나지 않는 한, 브라우저는 캐시에 저장된 js 파일을 계속 사용한다.
